<?xml version="1.0" encoding="UTF-8"?>
<document>
	<properties>
		<title>Reverse proxy servlets</title>
		<author email="francois-xavier.bonnet@centraliens.net">Francois-Xavier Bonnet</author>
		<author email="nricheton@users.sourceforge.net">Nicolas Richeton</author>
	</properties>
	<body>
		<h1>Reverse proxy servlets</h1>
		<section name="Reverse proxy servlets">
			<p>
				The toolkit includes two reverse proxy servlets which can be used
				to
				serve
				static resources
				from a distant application and can use the
				cache
				to improve performance.
		</p>
			<p>These servlet can also be used to start a Web Assemble Tool-based
				application without installing a separate Apache http server.</p>

			<subsection name="Basic reverse proxy">

				<h4>Configuration</h4>
				<p>
					The reverse proxy is a servlet that has to be configured in the
					web.xml
					file.
</p>
				<source>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE
web-app PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application
2.3//EN" "http://java.sun.com/dtd/web-app_2_3.dtd"&gt;
&lt;web-app&gt;
&lt;servlet&gt;
&lt;servlet-name&gt;proxy&lt;/servlet-name&gt;
&lt;servlet-class&gt;org.esigate.ProxyServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
&lt;servlet-name&gt;proxy&lt;/servlet-name&gt;
&lt;url-pattern&gt;/images/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
&lt;/web-app&gt; </source>
			</subsection>
			<subsection name="Rewrite reverse proxy">

				<h4>Description</h4>
				<p>This servlet has the ability to rewrite scheme, port, url and query
					string before processing the request (proxy or redirect). This is a simple alternative
					to Apache + mod_rewrite + mod_proxy.</p>
				<p>
					Once configured, this servlet is
					<b>equivalent</b>
					to the following
					<b>Apache configuration</b>
					:
				</p>
				<source>
RewriteEngine On
ProxyRequests Off
&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

# URL rewriting
RewriteRule ^/myurl(/?.*)$ http://localhost:8080/webappcontext$1 [P,L]

# URL + query rewriting
RewriteCond %{QUERY_STRING} ^(.+)$
RewriteRule ^/myurl(/?.*)$
http://localhost:8080/webappcontext$1?%1&amp;additionnalparam=value   [P,L]

&lt;Location /myurl&gt;
ProxyPassReverse http://localhost:8080/webappcontext
ProxyPassReverseCookiePath /webappcontext /
&lt;/Location&gt;

# URL + redirect
RewriteRule ^/myurl(/?.*)$ http://localhost:8080/webappcontext$1 [R=301,L]

# URL + scheme
RewriteCond  %{HTTPS}  on
RewriteRule ^/myurl(/?.*)$ http://localhost:8080/webappcontext$1 [R=301,L]

# URL + port
RewriteCond  %{SERVER_PORT}  8181
RewriteRule ^/myurl(/?.*)$ http://localhost:8080/webappcontext$1 [R=301,L]

 </source>

				<h4>Configuration</h4>
				<p>Add this servlet to your web application. You can also create a
					dedicated application deployed on the ROOT context. This way you have full control on the url.</p>
				<source>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE
web-app PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application
2.3//EN" "http://java.sun.com/dtd/web-app_2_3.dtd"&gt;
&lt;web-app&gt;
&lt;servlet&gt;
&lt;servlet-name&gt;proxy&lt;/servlet-name&gt;
&lt;servlet-class&gt;org.esigate.RewriteProxyServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
&lt;servlet-name&gt;proxy&lt;/servlet-name&gt;
&lt;url-pattern&gt;/images/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
&lt;/web-app&gt; </source>
					
					
					<p>Then the proxy has to be configured in both org/esigate/driver.properties and org/esigate/rewrite-proxy.properties :</p>
					<p>driver.properties</p>
						<source>
#org/esigate/driver.properties


webapp.remoteUrlBase=http://localhost:8080/webappcontext/
					</source>
					<p>rewrite-proxy.properties</p>
					<source>
#org/esigate/rewrite-proxy.properties

# Rule 1. (replace &lt;rulename1&gt; by the real rule name)
&lt;rulename1&gt;.pattern=^/myurl(/?.*)$
&lt;rulename1&gt;.rewrite=$1
&lt;rulename1&gt;.provider=webapp


# Rule 2 (replace &lt;rulename2&gt; by the real rule name)
&lt;rulename2&gt;.pattern=^/myurl(/?.*)$
&lt;rulename2&gt;.queryPattern=^(.+)$
&lt;rulename2&gt;.rewrite=$1
&lt;rulename2&gt;.queryRewrite=$1&amp;additionnalparam=value
&lt;rulename2&gt;.provider=webapp

# Rule 3 (replace &lt;rulename3&gt; by the real rule name)
&lt;rulename3&gt;.pattern=^/myurl(/?.*)$
&lt;rulename3&gt;.rewrite=/webappcontext$1
&lt;rulename3&gt;.redirect=301

# Rule 4 (replace &lt;rulename4&gt; by the real rule name)
&lt;rulename4&gt;.pattern=^/myurl(/?.*)$
&lt;rulename4&gt;.rewrite=/webappcontext$1
&lt;rulename4&gt;.schemePattern=https
&lt;rulename4&gt;.schemeRewrite=http
&lt;rulename4&gt;.redirect=301

# Rule 5 (replace &lt;rulename5&gt; by the real rule name)
&lt;rulename5&gt;.pattern=^/myurl(/?.*)$
&lt;rulename5&gt;.rewrite=/webappcontext$1
&lt;rulename5&gt;.portPattern=8181
&lt;rulename5&gt;.portRewrite=8080
&lt;rulename5&gt;.redirect=301
					</source>
			</subsection>

			<subsection name="Other reverse proxy solutions">
				<p>
					In a production environment under very heavy load it may be more
					efficient to use instead other tools such as Apache mod_proxy
</p>
			</subsection>
		</section>
	</body>
</document>